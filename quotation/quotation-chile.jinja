{# ============================ PRINT FORMAT: Cotización (Quotation) - Chile -
RUT empresa/cliente - CLP sin decimales - Imagen de producto si existe -
wkhtmltopdf friendly ============================ #} {% set currency = "CLP" %}
{% set items = doc.items or [] %} 
{# Fetch full Company doc for Logo, Phone, Website #}
{% set company_doc = frappe.get_doc("Company", doc.company) %}
{# RUT Empresa #} {% set company_rut = company_doc.tax_id %}
{# RUT Cliente (en ERPNext suele estar en Customer.tax_id) #} {% set
customer_rut = frappe.db.get_value("Customer", doc.customer, "tax_id") if
doc.customer else "" %} {# helpers dinero CLP #} {% macro clp(val) -%} {{
frappe.utils.fmt_money(val or 0, currency=currency, precision=0) }} {%- endmacro
%}
{# Fetch Bank Account #}
{% set bank_acct = frappe.db.get_value("Bank Account", {"company": doc.company, "is_default": 1, "disabled": 0}, "*", as_dict=True) or frappe.db.get_value("Bank Account", {"company": doc.company, "disabled": 0}, "*", as_dict=True) %}

<div class="pf">
  {% if doc.docstatus == 0 %}
  <div class="draft-header">BORRADOR</div>
  {% endif %}

  <!-- Header -->
  <div class="header">
    <div class="h-left">
      <div class="title">COTIZACIÓN</div>
      <div class="meta">
        <div>
          <span class="k">N°</span> <span class="v">{{ doc.name }}</span>
        </div>
        <div>
          <span class="k">Fecha</span>
          <span class="v">{{ frappe.format_date(doc.transaction_date) }}</span>
        </div>
        {% if doc.valid_till %}
        <div>
          <span class="k">Válida hasta</span>
          <span class="v">{{ frappe.format_date(doc.valid_till) }}</span>
        </div>
        {% endif %} {% if doc.po_no %}
        <div>
          <span class="k">OC Cliente</span>
          <span class="v">{{ doc.po_no }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="h-right">
      <div class="hr-table">
        <div class="hr-details">
          <div class="company">{{ doc.company }}</div>
          {% if company_rut %}
          <div class="muted"><span class="k2">RUT</span> {{ company_rut }}</div>
          {% endif %} 
          
          {% if company_doc.address %}
          <div class="muted">{{ company_doc.address }}</div>
          {% endif %}
          
          {% if company_doc.phone_no %}
          <div class="muted">Tel: {{ company_doc.phone_no }}</div>
          {% endif %}
          
          {% if company_doc.website %}
          <div class="muted">{{ company_doc.website }}</div>
          {% endif %}
          
          {% if company_doc.email %}
          <div class="muted">{{ company_doc.email }}</div>
          {% endif %}
        </div>
        <div class="hr-logo">
          <img src="https://domosdelsur.cl/logo-black.svg" />
        </div>
      </div>
    </div>
  </div>

{# Fetch Customer Phone #}
{% set contact_phone = "" %}
{% if doc.contact_person %}
    {% set contact_phone = frappe.db.get_value("Contact", doc.contact_person, "mobile_no") or frappe.db.get_value("Contact", doc.contact_person, "phone") %}
{% endif %}

{# Fetch Salesperson Details #}
{% set salesperson = frappe.get_doc("User", doc.owner) %}

  <!-- Parties (Two Cards) -->
  <div class="grid2" style="margin-bottom: 12px;">
    <div>
      <div class="card" style="margin-bottom: 0; min-height: 100%;">
        <div class="pf-label">Cliente</div>
        <div class="strong">{{ doc.customer_name or "-" }}</div>
        {% if customer_rut %}
        <div class="muted"><span class="k2">RUT</span> {{ customer_rut }}</div>
        {% endif %} {% if doc.customer_address %}
        <div class="muted">
          {{ doc.customer_address_display or doc.customer_address }}
        </div>
        {% endif %} {% if doc.contact_person %}
        <div class="muted">
          Contacto: {{ doc.contact_display or doc.contact_person }}
        </div>
        {% endif %}
        {% if contact_phone %}
        <div class="muted">{{ contact_phone }}</div>
        {% endif %}
        {% if doc.contact_email %}
        <div class="muted">{{ doc.contact_email }}</div>
        {% endif %}
      </div>
    </div>

    <div>
      <div class="card" style="margin-bottom: 0; min-height: 100%;">
        <div class="pf-label">Condiciones comerciales</div>
        <div class="pf-row">
          <span class="k">Vendedor</span
          ><span class="v">{{ salesperson.full_name or doc.owner }}</span>
        </div>
        <div class="pf-row">
          <span class="k">Lista de precios</span
          ><span class="v">{{ doc.selling_price_list or "-" }}</span>
        </div>
        <div class="pf-row">
          <span class="k">Términos de pago</span
          ><span class="v">{{ doc.payment_terms_template or "-" }}</span>
        </div>
        {% if doc.delivery_date %}
        <div class="pf-row">
          <span class="k">Entrega</span
          ><span class="v">{{ frappe.format_date(doc.delivery_date) }}</span>
        </div>
        {% endif %} {% if doc.incoterm %}
        <div class="pf-row">
          <span class="k">Incoterm</span
          ><span class="v">{{ doc.incoterm }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Items -->
  <div class="card">
    <div class="section-title">Detalle</div>

    <table class="items">
      <thead>
        <tr>
          <th class="col-idx">#</th>
          <th class="col-img">Imagen</th>
          <th class="col-desc">Detalle</th>
          <th class="col-qty">Cant.</th>
          <th class="col-rate">Precio</th>
          <th class="col-amt">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        {# Logic to get image path #}
        {% set item_img_path = it.image %}
        {% if not item_img_path and it.item_code %}
             {% set item_img_path = frappe.db.get_value("Item", it.item_code, "image") %}
        {% endif %}

        {% set img_src = "" %}
        {% if item_img_path %}
            {# Use raw path so browser resolves port automatically. 
               Avoids get_url() mismatch when host_name config is missing port. 
            #}
            {% set img_src = item_img_path %}
        {% endif %}

        <tr class="avoid-break">
          <td class="col-idx">{{ loop.index }}</td>

          <td class="col-img">
            {% if img_src %}
            <div class="item-image">
                <img class="pimg" src="{{ img_src }}" alt="img" />
            </div>
            {% endif %}
          </td>

          <td class="col-desc">
            <div class="strong">{{ it.item_name or it.item_code }}</div>
            {% if it.item_code %}
            <div class="muted">{{ it.item_code }}</div>
            {% endif %}
            <div class="desc" style="margin-top: 4px;">
              {{ (it.description or "") | replace("\n", "<br />") }}
            </div>
          </td>

          <td class="col-qty">
            {{ frappe.format_value(it.qty, {"fieldtype":"Float"}) }} {% if
            it.uom %}
            <div class="muted">{{ it.uom }}</div>
            {% endif %}
          </td>

          <td class="col-rate">{{ clp(it.rate) }}</td>

          <td class="col-amt">{{ clp(it.amount) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Block 1: Resumen & Calendario de Pago (Side by Side, 2 separate Cards) -->
  <div class="totals-wrap avoid-break">
      <!-- Left: Payment Schedule -->
      <div class="notes">
          <div class="card" style="margin-bottom: 0; min-height: 100%;">
            {% if doc.payment_schedule and doc.payment_schedule|length > 0 %}
            <div class="section-title">Calendario de Pago</div>
            <table class="items" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="text-align: left;">Cuota</th>
                        <th style="text-align: left;">Vencimiento</th>
                        <th style="text-align: right;">%</th>
                        <th style="text-align: right;">Monto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ps in doc.payment_schedule %}
                    <tr>
                        <td>{{ ps.description or ps.payment_term }}</td>
                        <td>{{ frappe.format_date(ps.due_date) }}</td>
                        <td style="text-align: right;">{{ ps.invoice_portion | round(2) }}%</td>
                        <td style="text-align: right;">{{ clp(ps.payment_amount) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
               <div class="muted">Sin calendario de pago definido.</div>
            {% endif %}
          </div>
      </div>

      <!-- Right: Resumen -->
      <div class="totals">
        <div class="totals-content">
            <div class="section-title">Resumen</div>

            <div class="trow">
              <span class="k">Neto</span>
              <span class="v">{{ clp(doc.total) }}</span>
            </div>

            {% if doc.discount_amount and doc.discount_amount != 0 %}
            <div class="trow">
              <span class="k">Descuento</span>
              <span class="v">- {{ clp(doc.discount_amount) }}</span>
            </div>
            {% endif %} 
            
            {# Impuestos (IVA u otros) #} 
            {% if doc.taxes and doc.taxes|length %} 
                {% for tx in doc.taxes %} 
                    {% if tx.tax_amount and tx.tax_amount != 0 %}
                    <div class="trow">
                      <span class="k">{{ tx.description or tx.account_head or "Impuesto" }}</span>
                      <span class="v">{{ clp(tx.tax_amount) }}</span>
                    </div>
                    {% endif %} 
                {% endfor %} 
            {% endif %}

            <div class="trow grand">
              <span class="k">TOTAL</span>
              <span class="v">{{ clp(doc.grand_total) }}</span>
            </div>

            {% if doc.in_words %}
            <div class="in-words muted">{{ doc.in_words }}</div>
            {% endif %}
        </div>
      </div>
  </div>

  <!-- Block 2: Transfer Details & Terms -->
  <div class="card avoid-break">
      {% if bank_acct %}
      <div class="section-title">Datos de Transferencia</div>
      <div class="muted" style="margin-bottom: 15px;">
          <div><strong>Banco:</strong> {{ bank_acct.bank or "-" }}</div>
          <div><strong>Nombre:</strong> {{ bank_acct.account_name or "-" }}</div>
          <div><strong>Tipo:</strong> {{ bank_acct.account_type or "-" }}</div>
          <div><strong>N° Cuenta:</strong> {{ bank_acct.bank_account_no or "-" }}</div>
          <div><strong>RUT:</strong> {{ company_doc.tax_id }}</div>
          {% if company_doc.email %}
          <div><strong>Email:</strong> {{ company_doc.email }}</div>
          {% endif %}
      </div>
      {% endif %}

      {% if doc.terms %}
      <div class="section-title" style="{% if bank_acct %}margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;{% endif %}">Términos</div>
      <div class="muted terms" style="border-left: none; padding-left: 0;">{{ doc.terms | replace("\n", "<br />") }}</div>
      {% endif %}

      {% if doc.note %}
      <div class="section-title" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">Nota</div>
      <div class="muted">{{ doc.note | replace("\n", "<br />") }}</div>
      {% endif %}
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="muted">
      Documento generado desde ERPNext • {{
      frappe.format_date(frappe.utils.nowdate()) }}
    </div>
    <div class="muted right">Emitido por: {{ frappe.db.get_value("User", doc.owner, "full_name") or doc.owner }}</div>
  </div>
</div>
